from typing import Dict, List, TypedDict

SYSTEM_PROMPT = """
РОЛЬ
Ты — «Продуктовый Наставник»: опытный продуктовый менеджер-наставник, ведущий пользователя строго по методологии Фёдора. 
Работаешь пошагово, без пропусков, с явными подтверждениями и фиксируешь решения.

ИСТОЧНИКИ ЗНАНИЙ
Ты используешь встроенную методологию (13 артефактов). Не ссылайся на внешние файлы, говори от себя.

ГЛАВНЫЕ ПРАВИЛА
1) Строгая последовательность 13 артефактов. Порядок менять нельзя.
2) Цикл на каждый артефакт:
   - Объясняешь цель
   - Даёшь 2–3 варианта (A/B/C)
   - Запрашиваешь выбор/правки
   - Вносишь правки
   - Просишь явное подтверждение
3) Переход вперёд — ТОЛЬКО после явного подтверждения пользователя (“подтверждаю”, “да, дальше”, “approve”).
4) Перед переходом проверь критерии качества артефакта.
5) Храни контекст утверждённых артефактов как «истину».

ТОН
Чёткий, дружелюбный, прикладной. Короткие блоки, понятные критерии.

TOOLING RULES
- У тебя есть тул по поиску (`search_kb`) на FAISS-индексе (`./data/theo_index`). Используй его, когда нужен фактический контекст или доменное знание.
- Запрос должен быть короткий (несколько ключевых слов или один чёткий вопрос). Не вставляй полные промпты.
- Не более 1–2 поисков за ход; бери наиболее релевантные отрывки.
- Если ничего не нашлось или тул выдал ошибку, скажи об этом и не изобретай факты.
"""

class ArtifactDefinition(TypedDict):
    id: int
    name: str
    goal: str
    methodology: str
    criteria: List[str]

ARTIFACTS: List[ArtifactDefinition] = [
    {
        "id": 0,
        "name": "Продуктовая троица",
        "goal": "Определить сегмент, проблему и решение.",
        "methodology": "Сегмент должен быть растущим, боль реальной, решение масштабируемым.",
        "criteria": ["Сегмент растущий", "Реальная боль на языке клиента", "Потенциал 2x-30x", "Тезисы проверяемы"]
    },
    {
        "id": 1,
        "name": "Карточка инициативы",
        "goal": "Сформировать паспорт проекта.",
        "methodology": "Заполнить все разделы: проблема, решение, рынок, команда, метрики.",
        "criteria": ["Все разделы заполнены", "Сегменты конкретны", "Проблема на языке клиента", "Относительные метрики"]
    },
    {
        "id": 2,
        "name": "Карта стейкхолдеров",
        "goal": "Определить всех заинтересованных лиц и их влияние.",
        "methodology": "Матрица влияния/интереса.",
        "criteria": ["Роли/интересы определены", "Влияние оценено", "Риски учтены", "Матрица взаимодействия"]
    },
    {
        "id": 3,
        "name": "Бэклог гипотез",
        "goal": "Собрать список гипотез для проверки.",
        "methodology": "HADI циклы, приоритезация ICE/RICE.",
        "criteria": ["Формула гипотезы", "Метрика успеха", "Приоритет (ICE/RICE)", "Связь с болью"]
    },
    {
        "id": 4,
        "name": "Глубинное интервью",
        "goal": "Подтвердить проблему через интервью.",
        "methodology": "CustDev, открытые вопросы.",
        "criteria": ["Целевая выборка", "Сценарий", "Инсайты с цитатами", "Ссылки на сырьё"]
    },
    {
        "id": 5,
        "name": "Ценностное предложение",
        "goal": "Сформулировать выгоду для клиента.",
        "methodology": "Value Proposition Canvas.",
        "criteria": ["Связка боль->выгода", "Top-3 ценности", "Проверяемые обещания"]
    },
    {
        "id": 6,
        "name": "Карта путешествия клиента (CJM)",
        "goal": "Визуализировать путь клиента.",
        "methodology": "Путь от возникновения потребности до решения.",
        "criteria": ["Стадии", "Боли/эмоции", "Точки контакта", "Возможности улучшения"]
    },
    {
        "id": 7,
        "name": "Карта бизнес-процессов",
        "goal": "Описать процессы AS-IS и TO-BE.",
        "methodology": "BPMN или простая схема.",
        "criteria": ["AS-IS/TO-BE", "Входы/выходы", "Владельцы", "Узкие места"]
    },
    {
        "id": 8,
        "name": "Конкурентный анализ",
        "goal": "Сравнить с конкурентами.",
        "methodology": "Сравнение по фичам, ценам, опыту.",
        "criteria": [">=5 альтернатив", "Сравнительная таблица", "Дифференциация"]
    },
    {
        "id": 9,
        "name": "УТП",
        "goal": "Сформулировать Уникальное Торговое Предложение.",
        "methodology": "Почему купят именно у нас.",
        "criteria": ["Одна чёткая формула", "Доказуемые преимущества", "Релевантно сегменту"]
    },
    {
        "id": 10,
        "name": "Финансовая модель",
        "goal": "Оценить экономику проекта.",
        "methodology": "Unit-экономика, P&L.",
        "criteria": ["Ключевые допущения", "LTV/CAC/маржа", "Чувствительность", "Сценарии"]
    },
    {
        "id": 11,
        "name": "Дорожная карта",
        "goal": "План реализации.",
        "methodology": "Gantt или список релизов.",
        "criteria": ["Релизы", "Цели/метрики", "Ресурсы/риски", "Вехи"]
    },
    {
        "id": 12,
        "name": "Карточка проекта",
        "goal": "Финальная сводка.",
        "methodology": "Summary всего проекта.",
        "criteria": ["Сводка по 1-12", "Роли/ответственность", "Критерии готовности", "Go/No-Go"]
    }
]

PROGRESS_BAR_TEMPLATE = """
════════════════════════════════
ПРОГРЕСС: {progress_bar} ({current}/{total})
ТЕКУЩИЙ: {current_name}
СЛЕДУЮЩИЙ: {next_name}
════════════════════════════════
"""
